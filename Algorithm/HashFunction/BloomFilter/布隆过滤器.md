#### 布隆过滤器
1）利用哈希函数的性质
2）每一条数据提取特征
3）加入描黑库

#### 布隆过滤器的应用
应用一：
假设有一个Set集合，里面存储的黑名单URL，一共有100亿个黑名单，每一个黑名单URL占用64字节
如果使用HashSet进行存储，该HashSet表示一个服务，该服务就需要占用6400亿字节，也就是640G的空间

布隆过滤器解决类似于黑名单的问题，可以极大地节省空间，可能200多个G就搞定了
布隆过滤器一定有失误率，但是可以通过设计，将失误率控制在一个范围内
布隆过滤器失误率，在Set集合中的黑名单URL一定不会出现失误，但如果不是Set集合中的URL，可能有万分之一的概率误报，
类似于错杀三千不放过一个

应用二：
公司都会做爬虫，有爬虫1、爬虫2、爬虫3、爬虫4...，一旦爬虫1捕捉到一个URL地址，其它爬虫就不能重复捕捉，将爬虫1捕捉的
URL地址加到类似于实现黑名单功能的服务中，作为黑名单的一部分，之后的其它的爬虫直接略过该URL，节省资源

类似于黑名单：可能实现的不是现实意义的黑名单，但它类似于黑名单的功能

#### 布隆过滤器的设计
位图

布隆过滤器的桶的大小为M，M越大失误率越小，但失误率不可避免
M越小失误率越大

布隆过滤器的桶的大小M和什么有关？
1.样本量
2.失误率
布隆过滤器的桶的大小M和什么无关？
1.单样本大小

#### 布隆过滤器的三个重要的公式
1，假设数据量为n，预期的失误率为p（布隆过滤器大小和每个样本的大小无关）
2，根据n和p，算出Bloom Filter一共需要多少个bit位，向上取整，记为m
3，根据m和n，算出Bloom Filter需要多少个哈希函数，向上取整，记为k
4，根据修正公式，算出真实的失误率p_true

第一个重要的公式
![img.png](img.png)
M = (样本量)N * (以e为底的失误率)ln P / (ln 2)的2次方

M是布隆过滤器的空间，一定是一个整数，所以可以向上取整

布隆过滤器需要确定两个条件，M的大小，哈希函数的个数K

哈希函数的个数K比较小时，采样率不足，会导致失误率的上升
哈希函数的个数K比较大时，M的空间会被耗尽，失误率也会上升

第二个重要的公式
![img_1.png](img_1.png)
K = ln 2 * 布隆过滤器空间的大小M / 样本量N

第三个重要的公式
![img_2.png](img_2.png)
P = (1 - e的(- 样本量N * 哈希函数的个数K / 布隆过滤器空间大小M))的K次方

举例：
假设样本量N = 100亿 失误率P = 0.0001
带入第一个公式：M = bit数量，实际计算空间是Byte，所以M需要/ 8，最终的布隆过滤器的空间大小M = 17G

对面试官提出要求：现在至少需要17G的空间能够支持你这个要求，请问能不能将17G空间提升到20G的空间，将失误率降得更少一点
如果面试官同意，现在就有两个值：1、理论上至少需要的空间M = 17G，2、实际拿到的空间M' = 20G

哈希函数真实的个数K = 真实的M' / 样本量N * 0.7 = (理论的哈希函数个数K)12.7个 --> 向上取整(实际的哈希函数个数K')13个

13个哈希函数如何得到
两个函数f1 和 f2
1) 1 * f1的返回值 + f2的返回值
2) 2 * f1的返回值 + f2的返回值
3) 3 * f1的返回值 + f2的返回值
4) 4 * f1的返回值 + f2的返回值
5) 5 * f1的返回值 + f2的返回值
   ...
   K) K * f1的返回值 + f2的返回值
   13个函数得到的返回值可能超出f1和f2的范围，没关系，反正最后一定会 % M

通过真实的布隆过滤器空间大小M' 和 真实的哈希函数个数K' 计算出真实的失误率P' 这个真实的失误率P'一定比原来的失误率P小

----------------------------------  -------------------------------------------------
1.首先问面试官：咱这个布隆过滤器系统允许有失误率吗？
如果不允许有失误率，那一定是别的方式，反正肯定不是布隆过滤器
如果允许有失误率，那一定是布隆过滤器

2.根据原来的失误率P计算出M，问面试官：咱这个布隆过滤器空间大小M能不能从理论值稍微往上大一点点，如果不同意就拿理论值算
如果同意，就得到一个真实的布隆过滤器空间大小M'

3.根据M'以及面试官给的条件计算出哈希函数的个数K，向上取整之后得到真实的哈希函数的个数K'

4.最后根据样本量N、真实的布隆过滤器空间大小M'、真实的哈希函数的个数K'，计算出真实的失误率P'，这个P'一定比原来的P小

举例：
HDFS 高密度文件系统

三个区域

如果三个区域不是布隆过滤器，想找到某一个字符串"abc"，那么只能MapReduce
如果三个区域是布隆过滤器，假设第一个和第三个区域报有"abc"，那么只需要在第一个和第三个区域找就行了
|——————|  |——————|  |——————|
|      |  |      |  |      |
|——————|  |——————|  |——————|

HyperLogLog 林子大什么鸟都有，所以可以用鸟有多怪，评估林子有多大，这就是哲学

#### 布隆过滤器的注意事项
布隆过滤器无法支持删除操作，实际上能支持，假设服务器有三台，使用哈希函数计算三次哈希值，使用 0 0两个位数表示一个bit，
该bit记录一次，01，该bit记录两次，10，该bit记录三次及三次以上，11，布隆过滤器支持单样本一次的删除

布谷鸟过滤器支持删除，但是也会有失误率